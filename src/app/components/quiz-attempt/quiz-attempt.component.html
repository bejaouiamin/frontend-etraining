<app-header></app-header>
<div class="quiz-attempt-container">
  <div class="header-section">
    <h1>
      <mat-icon>history</mat-icon>
      Historique des Quiz
    </h1>
    <button mat-icon-button (click)="refreshHistory()" matTooltip="Actualiser">
      <mat-icon>refresh</mat-icon>
    </button>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card total">
      <mat-icon>assignment</mat-icon>
      <div class="stat-content">
        <span class="stat-value">{{ totalAttempts }}</span>
        <span class="stat-label">Tentatives</span>
      </div>
    </div>
    <div class="stat-card passed">
      <mat-icon>check_circle</mat-icon>
      <div class="stat-content">
        <span class="stat-value">{{ passedQuizzes }}</span>
        <span class="stat-label">Quiz Réussis</span>
      </div>
    </div>
    <div class="stat-card average">
      <mat-icon>trending_up</mat-icon>
      <div class="stat-content">
        <span class="stat-value">{{ averageScore }}%</span>
        <span class="stat-label">Score Moyen</span>
      </div>
    </div>
    <div class="stat-card best">
      <mat-icon>emoji_events</mat-icon>
      <div class="stat-content">
        <span class="stat-value">{{ bestScore }}%</span>
        <span class="stat-label">Meilleur Score</span>
      </div>
    </div>
  </div>

  <!-- Candidate Info Card -->
  <mat-card class="candidate-card" *ngIf="candidate">
    <mat-card-header>
      <mat-icon mat-card-avatar>person</mat-icon>
      <div class="header-info">
        <mat-card-title>{{ candidate.fullName }}</mat-card-title>
        <mat-card-subtitle>{{ candidate.email }}</mat-card-subtitle>
      </div>
      <mat-chip [class]="'status-' + (candidate.statut ? candidate.statut.toLowerCase() : 'actif')">
        {{ candidate.statut || 'ACTIF' }}
      </mat-chip>
    </mat-card-header>

    <mat-card-content *ngIf="candidate">
      <div class="candidate-details-grid">
        <!-- Contact Information -->
        <div class="info-section">
          <h3 class="section-title">
            <mat-icon>phone</mat-icon>
            Contact
          </h3>
          <div class="info-item">
            <span class="label">Téléphone:</span>
            <span class="value">{{ candidate.phone }}</span>
          </div>
          <div class="info-item">
            <span class="label">Email:</span>
            <span class="value">{{ candidate.email }}</span>
          </div>
        </div>

        <!-- Address Information -->
        <div class="info-section" *ngIf="candidate.address">
          <h3 class="section-title">
            <mat-icon>location_on</mat-icon>
            Adresse
          </h3>
          <div class="info-item">
            <span class="label">Rue:</span>
            <span class="value">{{ candidate.address.rue }}</span>
          </div>
          <div class="info-item">
            <span class="label">Ville:</span>
            <span class="value">{{ candidate.address.ville }}</span>
          </div>
          <div class="info-item">
            <span class="label">Code Postal:</span>
            <span class="value">{{ candidate.address.codePostal }}</span>
          </div>
          <div class="info-item">
            <span class="label">Pays:</span>
            <span class="value">{{ candidate.address.pays }}</span>
          </div>
        </div>

        <!-- Important Dates -->
        <div class="info-section">
          <h3 class="section-title">
            <mat-icon>event</mat-icon>
            Dates
          </h3>
          <div class="info-item">
            <span class="label">Date d'inscription:</span>
            <span class="value">{{ formatDate(candidate.dateInscription) }}</span>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Chargement...</p>
  </div>

  <!-- Quiz History Table -->
  <mat-card class="history-card" *ngIf="!isLoading">
    <mat-card-header>
      <mat-icon mat-card-avatar>history</mat-icon>
      <mat-card-title>Historique des tentatives</mat-card-title>
      <mat-card-subtitle>{{ quizHistory.length }} tentative(s)</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div *ngIf="quizHistory.length === 0" class="no-history">
        <mat-icon>quiz</mat-icon>
        <h3>Aucune tentative de quiz</h3>
        <p>Vous n'avez pas encore passé de quiz. Commencez par suivre une leçon !</p>
      </div>

      <table mat-table [dataSource]="quizHistory" *ngIf="quizHistory.length > 0" class="history-table">
        <!-- Quiz Name Column -->
        <ng-container matColumnDef="quiz">
          <th mat-header-cell *matHeaderCellDef>Quiz</th>
          <td mat-cell *matCellDef="let attempt">
            <div class="quiz-name">
              <mat-icon>quiz</mat-icon>
              <span>Quiz #{{ attempt.resourceId }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Date Column -->
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let attempt">
            <div class="date-cell">
              <mat-icon>calendar_today</mat-icon>
              <span>{{ formatDate(attempt.attemptedAt) }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Score Column -->
        <ng-container matColumnDef="score">
          <th mat-header-cell *matHeaderCellDef>Score</th>
          <td mat-cell *matCellDef="let attempt">
            <span class="score-badge" [ngClass]="getScoreClass(attempt.score)">
              {{ attempt.score }}%
            </span>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Statut</th>
          <td mat-cell *matCellDef="let attempt">
            <mat-chip [class.passed]="attempt.passed" [class.failed]="!attempt.passed">
              <mat-icon>{{ attempt.passed ? 'check_circle' : 'cancel' }}</mat-icon>
              {{ attempt.passed ? 'Réussi' : 'Échoué' }}
            </mat-chip>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </mat-card-content>
  </mat-card>
</div>
