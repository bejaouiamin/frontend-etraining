<app-header></app-header>
<div class="lesson-progress-container">
  <!-- Single Lesson View with Resources -->
  <div *ngIf="lessonId && lessonWithResources && !isResourceViewOpen" class="single-lesson-view">
    <mat-card class="lesson-card">
      <mat-card-header>
        <mat-icon mat-card-avatar>school</mat-icon>
        <mat-card-title>{{ lessonWithResources.title }}</mat-card-title>
        <mat-card-subtitle *ngIf="lessonWithResources.resources.length">
          <mat-icon>folder</mat-icon>
          {{ lessonWithResources.resources.length }} ressource(s)
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <p class="lesson-description">{{ lessonWithResources.description }}</p>

        <!-- Resources Grid -->
        <div class="resources-section">
          <h3>
            <mat-icon>folder</mat-icon>
            Ressources ({{ lessonWithResources.resources.length || 0 }})
          </h3>

          <div class="resources-grid">
            <div
              *ngFor="let resource of lessonWithResources.resources"
              class="resource-card"
              [class.completed]="resource.completed"
              (click)="openResource(resource)">

              <div class="resource-card-header">
                <div class="resource-icon-wrapper">
                  <mat-icon [class]="'resource-icon-' + resource.type.toLowerCase()">
                    {{ getResourceIcon(resource.type) }}
                  </mat-icon>
                </div>
                <div class="resource-info">
                  <h4 class="resource-title">{{ resource.title }}</h4>
                  <mat-chip [class]="getResourceBadgeClass(resource.type)">
                    {{ resource.type }}
                  </mat-chip>
                </div>
                <mat-chip *ngIf="resource.completed" class="status-chip completed">
                  <mat-icon>check_circle</mat-icon>
                  Complétée
                </mat-chip>
              </div>

              <div class="resource-card-content">
                <div class="resource-meta">
                  <div class="meta-item" *ngIf="resource.type === ResourceType.QUIZ && resource.passingScore">
                    <mat-icon>grade</mat-icon>
                    <span>Score min: {{ resource.passingScore }}%</span>
                  </div>
                  <div class="meta-item">
                    <mat-icon>access_time</mat-icon>
                    <span>Cliquez pour accéder</span>
                  </div>
                </div>
              </div>

              <div class="resource-card-footer">
                <button mat-button color="primary" (click)="openResource(resource); $event.stopPropagation()">
                  <mat-icon>open_in_new</mat-icon>
                  Ouvrir
                </button>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Resource View -->
  <div *ngIf="isResourceViewOpen && selectedResource" class="resource-view">
    <div class="resource-view-header">
      <button mat-icon-button (click)="closeResource()" class="close-button">
        <mat-icon>close</mat-icon>
      </button>
      <div class="resource-view-title">
        <mat-icon>{{ getResourceIcon(selectedResource.type) }}</mat-icon>
        <h2>{{ selectedResource.title }}</h2>
      </div>
      <mat-chip [class]="getResourceBadgeClass(selectedResource.type)">
        {{ selectedResource.type }}
      </mat-chip>
    </div>

    <div class="resource-view-content">
      <!-- Loading State -->
      <div *ngIf="isLoadingResource" class="resource-loading">
        <div class="loader"></div>
        <p>Chargement de la ressource...</p>
      </div>

      <!-- Video Player -->
      <div *ngIf="selectedResource.type === ResourceType.VIDEO && !isLoadingResource" class="video-container">
        <video
          controls
          controlsList="nodownload"
          (play)="isResourceViewOpen = true"
          (ended)="markResourceCompleted(selectedResource.id)"
          class="video-player">
          <source [src]="selectedResourceUrl" type="video/mp4">
          Votre navigateur ne supporte pas la lecture de vidéos.
        </video>
        <p class="instruction">Regardez la vidéo complètement pour la marquer comme complétée</p>
      </div>

      <!-- PDF Viewer -->
      <div *ngIf="selectedResource.type === ResourceType.PDF && !isLoadingResource" class="document-container">
        <div class="pdf-wrapper">
          <ngx-extended-pdf-viewer
            [src]="pdfSrc"
            [height]="'650px'"
            [textLayer]="true"
            [showHandToolButton]="true"
            [showZoomButtons]="true"
            [showPrintButton]="true"
            [showDownloadButton]="false"
            [showOpenFileButton]="false"
            [showPresentationModeButton]="false"
            [showRotateButton]="true"
            [showSecondaryToolbarButton]="true"
            [showSidebarButton]="true"
            [zoom]="'auto'">
          </ngx-extended-pdf-viewer>
        </div>
        <div class="document-actions">
          <p class="instruction">Consultez le document, puis confirmez votre lecture</p>
          <button
            mat-raised-button
            color="accent"
            (click)="markResourceCompleted(selectedResource.id)"
            [disabled]="selectedResource.completed">
            <mat-icon>check_circle</mat-icon>
            Marquer comme lu
          </button>
        </div>
      </div>

      <!-- Quiz -->
      <div *ngIf="selectedResource.type === ResourceType.QUIZ && !isLoadingResource" class="quiz-container">
        <mat-card class="quiz-form">
          <mat-card-header>
            <mat-icon mat-card-avatar>quiz</mat-icon>
            <mat-card-title>{{ selectedResource.title }}</mat-card-title>
            <mat-card-subtitle>
              Score minimum requis: {{ selectedResource.passingScore }}%
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <div class="quiz-questions" *ngIf="quizQuestions && quizQuestions.length > 0">
              <div class="question-item" *ngFor="let question of quizQuestions; let i = index">
                <div class="question-header">
                  <span class="question-number">Question {{ i + 1 }}</span>
                  <h3 class="question-text">{{ question.questionText }}</h3>
                </div>

                <div class="answers-list">
                  <div 
                    class="answer-option" 
                    *ngFor="let answer of question.answers"
                    [class.selected]="isAnswerSelected(question.id, answer.id)"
                    (click)="selectAnswer(question.id, answer.id)">
                    <div class="radio-button">
                      <div class="radio-inner" *ngIf="isAnswerSelected(question.id, answer.id)"></div>
                    </div>
                    <span class="answer-text">{{ answer.answerText }}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="no-questions" *ngIf="!quizQuestions || quizQuestions.length === 0">
              <mat-icon>error_outline</mat-icon>
              <p>Aucune question disponible pour ce quiz</p>
            </div>
          </mat-card-content>

          <mat-card-actions>
            <button 
              mat-raised-button 
              color="primary" 
              (click)="submitQuiz()"
              [disabled]="!quizQuestions || quizQuestions.length === 0">
              <mat-icon>check_circle</mat-icon>
              Soumettre le Quiz
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    </div>

    <div class="resource-view-footer">
      <button mat-stroked-button (click)="closeResource()">
        <mat-icon>arrow_back</mat-icon>
        Retour aux ressources
      </button>
    </div>
  </div>

  <!-- Theme Lessons List View -->
  <div *ngIf="themeId && lessons.length > 0" class="theme-lessons-view">
    <div class="theme-header">
      <h2>
        <mat-icon>library_books</mat-icon>
        Leçons du thème
      </h2>
      <mat-chip class="count-chip">{{ lessons.length }} leçon(s)</mat-chip>
    </div>

    <div class="lessons-grid">
      <mat-card *ngFor="let lesson of lessons" class="lesson-item-card">
        <mat-card-header>
          <mat-icon mat-card-avatar>menu_book</mat-icon>
          <mat-card-title>{{ lesson.title }}</mat-card-title>
          <mat-card-subtitle *ngIf="lesson.resources?.length">
            <mat-icon>folder</mat-icon>
            {{ lesson.resources?.length }} ressource(s)
          </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <p class="lesson-description">{{ lesson.description }}</p>

          <div class="lesson-meta">
            <div class="meta-item">
              <mat-icon>folder</mat-icon>
              <span>{{ lesson.resources?.length || 0 }} ressources</span>
            </div>
            <div class="meta-item" *ngIf="lesson.sequenceOrder">
              <mat-icon>tag</mat-icon>
              <span>Ordre: {{ lesson.sequenceOrder }}</span>
            </div>
          </div>
        </mat-card-content>

        <mat-card-actions>
          <button mat-button color="primary">
            <mat-icon>play_arrow</mat-icon>
            Commencer
          </button>
          <button mat-button>
            <mat-icon>info</mat-icon>
            Détails
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-icon class="loading-icon">hourglass_empty</mat-icon>
    <p>Chargement des leçons...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && !lessonWithResources && lessons.length === 0 && !isResourceViewOpen" class="empty-state">
    <mat-icon>sentiment_dissatisfied</mat-icon>
    <p>Aucune leçon disponible</p>
  </div>
</div>

